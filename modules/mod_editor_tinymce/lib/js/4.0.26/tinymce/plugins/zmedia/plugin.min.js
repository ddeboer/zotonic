tinymce.PluginManager.requireLangPack("zmedia");(function(){window.tinyMCEzMedia={toHTML:function(d,c){var a,b;a="z-tinymce-media z-tinymce-media-align-"+(c.align||"block");b='<img class="'+a+'" data-zmedia-id="'+d+'" data-zmedia-opts="'+JSON.stringify(c).replace(/\"/g,"&quot;")+'"  src="/admin/media/preview/'+d+'" />';return b}};tinymce.create("tinymce.plugins.ZotonicMediaPlugin",{init:function(d,e){var c=this,b,a,f={align:"block",size:"middle",crop:"",link:""};b=d.getParam("z_properties_dialog_enabled",true);a=d.getParam("z_insert_dialog_enabled",true);d.on("setContent",function(h){if(b){var g=$(d.getContainer()).find("iframe");g.contents().find("img.z-tinymce-media").addClass("z-active")}});d.addCommand("mceZotonicMedia",function(g){var h=g||d.selection.getNode();if(h&&c._domIsZMedia(h)){if(b){c._openPropertiesDialog(h)}}else{if(a){c._openInsertDialog(d,f)}}});d.on("click",function(g){if(g.srcElement.nodeName==="IMG"){d.execCommand("mceZotonicMedia",g.srcElement)}});d.on("postProcess",function(g){g.content=c._MediaHtmlToMarkers(g.content)});d.on("loadContent",function(g){d.setContent(c._zMarkersToMediaHtml(g.content))});d.on("beforeSetContent",function(g){g.content=c._zMarkersToMediaHtml(g.content)});d.addButton("zmedia",{icon:"image",title:"Insert a Zotonic media item",cmd:"mceZotonicMedia","class":"mce_image"});d.addMenuItem("zmedia",{icon:"image",text:"Insert Zotonic media item",context:"format",cmd:"mceZotonicMedia","class":"mce_image"})},getInfo:function(){return{longname:"Zotonic Media Plugin",author:"Arjan Scherpenisse",authorurl:"http://www.zotonic.com",infourl:"http://www.zotonic.com",version:tinymce.majorVersion+"."+tinymce.minorVersion}},_openPropertiesDialog:function(b){var c=this._zMediaIdFromDOM(b),a=this._zMediaOptsFromDOM(b);z_dialog_open({title:"Media properties",text:'<form id="zmedia-props-form" class="form">  <div class="row">      <div class="span3">          <img src="/admin/media/preview/'+c+'" class="z-tinymce-media-left" />      </div>      <div class="span6">          <div class="row">              <div class="span3">                  <div class="control-group">                      <label class="control-label">Alignment</label>                      <div class="controls">                          <label class="radio"><input type="radio" name="align" '+(a.align==="block"?'checked="checked"':"")+' value="block" id="a-block"> Between text</label>                          <label class="radio"><input type="radio" name="align" '+(a.align==="left"?'checked="checked"':"")+'value="left" id="a-left"> Aligned left</label>                          <label class="radio"><input type="radio" name="align" '+(a.align==="right"?'checked="checked"':"")+'value="right" id="a-right"> Aligned right</label>                      </div>                  </div>              </div>              <div class="span3">                  <div class="control-group">                      <label class="control-label">Size</label>                      <div class="controls">                          <label class="radio"><input type="radio" name="size" '+(a.size==="small"?'checked="checked"':"")+' value="small" id="a-small"> Small</label>                          <label class="radio"><input type="radio" name="size" '+(a.size==="middle"||a.size===undefined?'checked="checked"':"")+'value="middle" id="a-middle"> Middle</label>                          <label class="radio"><input type="radio" name="size" '+(a.size==="large"?'checked="checked"':"")+'value="large" id="a-large"> Large</label>                      </div>                  </div>              </div>          </div>          <div class="row">              <div class="span3">                  <div class="control-group">                      <label class="control-label">Crop</label>                      <div class="controls">                          <label class="checkbox"><input type="checkbox" name="crop" '+(a.crop==="crop"?'checked="checked"':"")+' value="crop" id="a-crop"> Crop image</label>                      </div>                  </div>              </div>              <div class="span3">                  <div class="control-group">                      <label class="control-label">Link</label>                      <div class="controls">                          <label class="checkbox"><input type="checkbox" name="link" '+(a.link==="link"?'checked="checked"':"")+' value="crop" id="a-link"> Make link</label>                      </div>                  </div>              </div>          </div>      </div>  </div>  <div class="modal-footer">      <button class="btn" id="zmedia-props-cancel">Cancel</button>      <button class="btn btn-primary" type="submit">Save Properties</button>  </div></form>'});$("#zmedia-props-form").submit(function(){var d,e={align:$("#zmedia-props-form input[name='align']:checked").val(),size:$("#zmedia-props-form input[name='size']:checked").val(),crop:$("#zmedia-props-form input[name='crop']:checked").val()?"crop":"",link:$("#zmedia-props-form input[name='link']:checked").val()?"link":""};
d=$(window.tinyMCEzMedia.toHTML(c,e));b.className=d.attr("class");$(b).attr("data-zmedia-opts",d.attr("data-zmedia-opts")).attr("data-zmedia-id",d.attr("data-zmedia-id"));z_dialog_close();return false});$("#zmedia-props-cancel").click(function(){z_dialog_close();return false})},_openInsertDialog:function(b,a){window.z_choose_zmedia=function(d){var c;if(!d){return}c=window.tinyMCEzMedia.toHTML(d,a);b.execCommand("mceInsertContent",false,c,{})};z_event("zmedia",{language:window.zEditLanguage(),is_zmedia:1})},_domIsZMedia:function(a){return this._zMediaIdFromDOM(a)!==null},_zMediaIdFromDOM:function(a){return a.getAttribute("data-zmedia-id")},_zMediaOptsFromDOM:function(a){return JSON.parse(a.getAttribute("data-zmedia-opts"))},_zMediaClass:function(){return"z-tinymce-media"},_MediaHtmlToMarkers:function(f){var i=new RegExp("<img.*?/>","g"),d,e,b,c,g,a,h;while(true){d=i.exec(f);if(d===null){break}e=d[0];b=(new RegExp('data-zmedia-id="([0-9]+)',"g")).exec(e);if(!b){return f}c=b[1];g=(new RegExp('data-zmedia-opts="(\\{.*?\\})"',"g")).exec(e);if(!g){return f}a=JSON.parse(g[1].replace(/&quot;/g,'"'));h=this._zMediaMarker(c,a);f=f.substr(0,i.lastIndex-e.length)+h+f.substr(i.lastIndex);i.lastIndex=i.lastIndex-e.length+h.length}return f},_zMediaMarker:function(b,a){return"<!-- z-media "+b+" "+JSON.stringify(a)+" -->"},_zMarkersToMediaHtml:function(c){var d=new RegExp("<!-- z-media (.*?) (.*?)-->","g"),a,f,e,b;while(true){a=d.exec(c);if(a===null){break}f=a[1];e=JSON.parse(a[2]);b=window.tinyMCEzMedia.toHTML(f,e);c=c.substr(0,d.lastIndex-a[0].length)+b+c.substr(d.lastIndex);d.lastIndex=d.lastIndex-a[0].length+b.length}return c}});tinymce.PluginManager.add("zmedia",tinymce.plugins.ZotonicMediaPlugin)}());